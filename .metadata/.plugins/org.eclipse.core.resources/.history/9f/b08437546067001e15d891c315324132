package scanqrcodeFromPdf;

import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.nio.file.Files;
import java.security.KeyFactory;
import java.security.interfaces.RSAPublicKey;
import java.security.spec.X509EncodedKeySpec;
import java.util.ArrayList;
import java.util.Base64;
import java.util.EnumMap;
import java.util.List;
import java.util.Map;

import javax.imageio.ImageIO;

import org.apache.commons.io.FileUtils;
import org.apache.pdfbox.Loader;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.rendering.ImageType;
import org.apache.pdfbox.rendering.PDFRenderer;
import org.json.JSONObject;

import com.google.gson.Gson;
import com.google.zxing.BinaryBitmap;
import com.google.zxing.DecodeHintType;
import com.google.zxing.LuminanceSource;
import com.google.zxing.MultiFormatReader;
import com.google.zxing.NotFoundException;
import com.google.zxing.Result;
import com.google.zxing.client.j2se.BufferedImageLuminanceSource;
import com.google.zxing.common.HybridBinarizer;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;

public class QRCodeExtractor {

	public static void main(String[] args) {
		try {

			QRCodeExtractor qrcode = new QRCodeExtractor();

			File sourceFile = new File("C:\\Users\\admn\\Downloads\\Invoice_sample (2)[68].pdf");
			InputStream fileInputstream = new FileInputStream(sourceFile);
			byte[] arr = Files.readAllBytes(sourceFile.toPath());

			File imageFile = new File("C:\\Users\\admn\\Downloads\\my_einvoice.png");

			byte[] img = FileUtils.readFileToByteArray(imageFile);
			RequestPayload requestPayload = new RequestPayload();
			requestPayload.setFileExtensionType(Enums.FileExtensionType.PNG);
			requestPayload.setScanMode(Enums.ScanMode.QRCODE);
			requestPayload.setDocType(Enums.DocType.E_INVOICE);
			requestPayload.setScandata(Enums.ScanData.DECODED_DATA);
			requestPayload.setInputType(Enums.InputType.BYTEARRAY);
			requestPayload.setSignValidata(true);
			requestPayload.setInputStream(fileInputstream);
			requestPayload.setByteArray(arr);
			//requestPayload.setByteArray(img);

			DecodedData decodedData = new DecodedData();
			decodedData.setPublicKey(
					"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA35ECb3t4DSCq3Wo4LONh3/jF+1k/S0MEareXFww+mm4AgymHheAWqhIGFQV6fbw2t/ZnG4TULXgYwBUCUffj+bqYAsvo2QyF9hbieGY2SDSieToUmyh8gtJZn0MG04d0NgFjunmnM/7ROkEAOXFvNDizO1NiKiOPbuLIOCrDvQdu48HNUR8Yg0pcMaOnBGVwasv4UIfMZXbBzjwngbwzK8M9jhp4y6xqsmF+wmFZhVpRhIa6nRDkedgroU5IlR/ntqDAhzk/p7zu2btAzA47HltfsGratEqFIBsj/ug+YFZh+8QOzbp2fizOo6DUdbYyJL7lxtEOdOI7ibKccnvlnQIDAQAB");
			requestPayload.setDecodedData(decodedData);

			//  PDF QR Code Response Data

			ResponseData responseData = qrcode.inputDataFromUser(requestPayload);
			Gson gson = new Gson();
			String json = gson.toJson(responseData);
			System.out.println("Response Data => \n" + json);
			
			
			
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		
	}

	private static String decodeQRCode(BufferedImage image) {
		try {

			LuminanceSource source = new BufferedImageLuminanceSource(image);
			BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));

			Result result = new MultiFormatReader().decode(bitmap);

			return result.getText();

		} catch (NotFoundException e) {
			// QR code not found in the image
			e.printStackTrace();
			return null;
		}

	}

	static ResponseData getDataFromPDFFile(byte[] data, boolean isDecode, boolean isValidate, DecodedData decodedData) {
		ResponseData responseData = new ResponseData();
		List<ResObj> resObjs = new ArrayList();
		try {
			PDDocument document = Loader.loadPDF(data);
			PDFRenderer pdfRenderer = new PDFRenderer(document);
			// Loop through each page in the PDF
			for (int page = 0; page < document.getNumberOfPages(); ++page) {
				// Render the page as an image
				ResObj resObj = new ResObj();
				BufferedImage image = pdfRenderer.renderImageWithDPI(page, 300, ImageType.RGB);
				// Decode QR code from the image
				String qrCodeData = decodeQRCode(image);
				resObj.setRawData(qrCodeData);
				System.out.println("QR  code EXtracted data" + qrCodeData);
				
				boolean isJwtString = JwtDataUtilityClass.isJWTString(qrCodeData);
				resObj.setQRContainsJWT(isJwtString);

				if (isJwtString && isDecode) {
					String[] qrData = qrCodeData.split("\\.");
					byte[] mydata = Base64.getDecoder().decode(qrData[1]);
					String content = new String(mydata, "UTF-8");

					Gson gson = new Gson();
					JSONObject jsonObject = new JSONObject(content);
					DecodeResponseData decodeResponseData = gson.fromJson(jsonObject.getString("data"),
							DecodeResponseData.class);
					resObj.setDecodeResponseData(decodeResponseData);
					if (isValidate) {
						RSAPublicKey key = JwtDataUtilityClass.generateKey(decodedData.getPublicKey());
						resObj.setEsignValid(JwtDataUtilityClass.validateToken(key, qrCodeData));
					}
				}

				resObjs.add(resObj);
			}
			// Close the PDF document
			document.close();
			responseData.setData(resObjs);
			responseData.setStatus(0);
			responseData.setMessage("Byte array extracted data successfully!!");
			return responseData;
		} catch (Exception e) {
			e.printStackTrace();
			responseData.setMessage(e.getMessage());
			responseData.setStatus(1);
		}
		return responseData;
	}

	private static ResponseData inputDataFromUser(RequestPayload reqpayload) {

		ResponseData responseData = new ResponseData();

		if (Enums.ScanMode.QRCODE.equals(reqpayload.getScanMode())) {

			responseData = validateQr(reqpayload);
		}
		
		
		
			
		 else {
			// Barcode Case
			responseData.setStatus(1);
			responseData.setMessage("Barcode validation is not imlplemented yet!");
		}
		return responseData;
	}

	private static ResponseData validateQr(RequestPayload reqpayload) {
		ResponseData responseData = new ResponseData();

		// E-invoice case
		responseData = validateScanType(reqpayload);

		// other doctypes

		responseData.setStatus(1);

		//responseData.setMessage("Only E-Invoice doctypes are handled!! ");
		
		//responseData.setMessage("Extracted  QR data From PDF");
		

		return responseData;
	}

	private static ResponseData validateScanType(RequestPayload reqpayload) {
		ResponseData responseData = new ResponseData();

		if (Enums.ScanData.RAW.equals(reqpayload.getScandata())) {
			// Raw scan case
			responseData = scanData(reqpayload, false, false);
		} else {
			// decoded data scan case
			responseData = scanData(reqpayload, true, reqpayload.isSignValidata());
		}
		return responseData;
	}

	private static ResponseData scanData(RequestPayload requestPayload, boolean isDecode, boolean isValidate) {

		ResponseData responseData = new ResponseData();

		if (Enums.FileExtensionType.PNG.equals(requestPayload.getFileExtensionType())) {
			if (Enums.InputType.BYTEARRAY.equals(requestPayload.getInputType())) {
				try {
					BufferedImage bufferedImage = ImageIO.read(new ByteArrayInputStream(requestPayload.getByteArray()));
					BinaryBitmap binaryBitmap = new BinaryBitmap(
							new HybridBinarizer(new BufferedImageLuminanceSource(bufferedImage)));
					Map<DecodeHintType, Object> hints = new EnumMap<>(DecodeHintType.class);
					hints.put(DecodeHintType.CHARACTER_SET, "UTF-8");
					MultiFormatReader reader = new MultiFormatReader();
					Result result = reader.decode(binaryBitmap, hints);
					System.out.println("Result -->" + result);
					ResObj obj = new ResObj();
					List<ResObj> objs = new ArrayList<>();
					// Decode QR code from the image
					boolean isJwtString = JwtDataUtilityClass.isJWTString(result.getText());
					obj.setQRContainsJWT(isJwtString);
					
					
					String rawData = result.getText();
					obj.setRawData(rawData);
					

					if (isJwtString && isDecode) {
						String[] qrData = rawData.split("\\.");
						byte[] mydata = Base64.getDecoder().decode(qrData[1]);
						String content = new String(mydata, "UTF-8");
						Gson gson = new Gson();
						JSONObject jsonObject = new JSONObject(content);
						DecodeResponseData decodeResponseData = gson.fromJson(jsonObject.getString("data"),
								DecodeResponseData.class);
						obj.setDecodeResponseData(decodeResponseData);
						if (isValidate) {
							RSAPublicKey key;
							key = JwtDataUtilityClass.generateKey(requestPayload.getDecodedData().getPublicKey());
							obj.setEsignValid(JwtDataUtilityClass.validateToken(key, rawData));
						}
					}
					objs.add(obj);
					responseData.setData(objs);
					responseData.setStatus(0);
					responseData.setMessage(" Png Byte array extracted data successfully!!");
					return responseData;
				} catch (Exception e) {
					e.printStackTrace();
					responseData.setMessage(e.getMessage());
					responseData.setStatus(1);
				}
				return responseData;
			}
		}
		if (!Enums.FileExtensionType.PDF.equals(requestPayload.getFileExtensionType())) {

			responseData.setStatus(1);
			responseData.setMessage("Provided file extension was not supported!!");
			return responseData;
		}

		if (Enums.InputType.PDFFILE.equals(requestPayload.getInputType()) 
				&& Enums.FileExtensionType.PDF.equals(requestPayload.getFileExtensionType())) {
			try {

				File sourceFile = new File("C:\\Users\\admn\\Downloads\\Invoice_sample (2)[68].pdf");
				// get the path from fileInputstream

				byte[] arr = Files.readAllBytes(sourceFile.toPath());
				responseData = getDataFromPDFFile(arr, isDecode, isValidate, requestPayload.getDecodedData());
				responseData.setMessage("Data extracted from PDF file Successfully!!");
				return responseData;
			} catch (Exception e) {
				e.printStackTrace();
				responseData.setMessage(e.getMessage());
				responseData.setStatus(1);
				return responseData;
			}
		} else if (Enums.InputType.INPUTSTRAM.equals(requestPayload.getInputType()) && Enums.FileExtensionType.PDF.equals(requestPayload.getFileExtensionType()) ) {
			try {
				InputStream fileInputstream = requestPayload.getInputStream();
				byte[] byteArray = fileInputstream.readAllBytes();
				responseData = getDataFromPDFFile(byteArray, isDecode, isValidate, requestPayload.getDecodedData());
				responseData.setMessage(" PDF FILE Inputstream Data extracted Successfully!!");
				return responseData;
			} catch (Exception e) {
				e.printStackTrace();
				responseData.setStatus(1);
				responseData.setMessage(e.getMessage());
				return responseData;
			}
		} else if (Enums.InputType.BYTEARRAY.equals(requestPayload.getInputType()) ) {
			return getDataFromPDFFile(requestPayload.getByteArray(), isDecode, isValidate,
					requestPayload.getDecodedData());
		}

		return null;

	}
	
	public  static ResponseData getQRdataFromImage() {
		try {
			// Load the QR code image (PNG or JPEG)
			BufferedImage image = ImageIO.read(new File("C:\\Users\\admn\\Downloads\\my_einvoice.png"));
			
			String qrCodeData = decodeQRCode(image);
  
			System.out.println("Image Qr DATA :"+qrCodeData);


		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}

	
	
	

}
